<!DOCTYPE html>
<html>
<head>
  <link href="vextab.css" rel="stylesheet" />
  <script src="vextab-div.js"></script>
  <script>
    Artist.prototype.origReset = Artist.prototype.reset;
    Artist.prototype.reset = function () {
      this.origReset();
        // see http://my.vexflow.com/articles/53#comment-2117647808
        this.customizations["beam-rests"] = "false";
      };
    </script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="icon" 
    type="image/png" 
    href="./favicon-play.ico">
  </head>

  <body>
    <nav class="navbar navbar-expand-lg  navbar-dark bg-dark">
      <a class="navbar-brand" href="./index.html">
        <button class="btn btn-dark"><i class="fas fa-play fa-sm"></i> Re:Music</button>
      </a>
      <div class="navbar-expand" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="#"><button type="button" class="btn btn-dark" data-toggle="modal" data-target="#exampleModal">
              Upload
            </button></a>
          </li>
        </ul>
      </div>
    </nav>

    

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
              <p id="upload_text"><i class="fas fa-cloud-upload-alt"></i>Drag the music score pdf file here</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="vex-tabdiv" width="680" scale="1.0" editor="true" editor_width="680" editor_height="80" style="position: relative;">stave clef=treble key=Bb time=4/4
notes :4 (Cn/4.E#/4.G@/4) $.a./bottom.$ $Hi$
notes :16 E##-F@@-G-A/5 $.a-/top.,..,.a>/top.,..$ $Team,Xin-Xin,Sophie,Zack$
notes :8 DTF-A/4 ^3^ $.a@u/bottom.$ :8d B/4 $.a@a/top.$ :16 ## | :4 A/4 T A/4
    </div>
    <br>
    <p>See <a href="http://my.vexflow.com/articles/134">http://my.vexflow.com/articles/134</a> for instructions on how to use Music Editor</p>

    <table id="scoresDisplay" class="table" style="width: 680px;">
      <thead class="thead-dark">
        <th scope="col">Scores</th>
      </thead>
      <tbody></tbody>
    </table>

    <script src="https://www.gstatic.com/firebasejs/5.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-storage.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script>
        // Initialize Firebase
        var config = {
          apiKey: "AIzaSyBXZfUvEUcCSOdZBWbw_PMY2XCAEaS9Q94",
          authDomain: "remusic-cf7bd.firebaseapp.com",
          databaseURL: "https://remusic-cf7bd.firebaseio.com",
          projectId: "remusic-cf7bd",
          storageBucket: "remusic-cf7bd.appspot.com",
          messagingSenderId: "484094823628"
        };
        firebase.initializeApp(config);
      </script>
      <script>
        function displayScores() {
          console.log("Im here display scores");
          var scoresRef = firebase.database().ref('scores');
          scoresRef.on('child_added', function (score) {
            displayScore(score);
          });
        }

        function displayScore(score) {
          console.log("Im here display score");
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          var a = document.createElement("a");
          a.setAttribute("href", "./score.html?id=" + score.key);
          a.appendChild(document.createTextNode(score.val().title));
          td.appendChild(a);
          tr.appendChild(td);
          $('#scoresDisplay').append(tr);
        }

        displayScores();

        var storage = firebase.storage();
        var database = firebase.database();
        var scores = database.ref("scores");
        var versions = database.ref("versions");
        function dropHandler(ev) {
          console.log('File(s) dropped');

          ev.preventDefault();

          if (ev.dataTransfer.items) {
            // DataTransferItemList interface
            if (ev.dataTransfer.items[0].kind === 'file'){
              var file = ev.dataTransfer.items[0].getAsFile();
              var len = file.name.length;
              var filename = file.name.substring(0,len-4);
              console.log('score name is ' + filename);
              var scoreItem = scores.push();
              scoreItem.set({
                title: filename
              }).then(function(snapshot){
                console.log("scores sent." + scoreItem.key)
              });
              var versionItem = database.ref("versions/"+scoreItem.key).push();
              versionItem.set({
                file: file.name
              }).then(function(snapshot){
                console.log("versions sent")
              });
              var pdfRef = storage.ref("pdfs/" + scoreItem.key + '/' + versionItem.key + '/' + file.name)
              pdfRef.put(file).then(function(snapshot) {
                console.log('Uploaded a file!');
              });

              var currentTime = new Date().toLocaleDateString();

            }
          }
        // Pass event to removeDragData for cleanup
        removeDragData(ev)
      }

      function dragOverHandler(ev) {
        console.log('File(s) in drop zone');
        ev.preventDefault();
      }
      function removeDragData(ev) {
        console.log('Removing drag data')

        if (ev.dataTransfer.items) {
          ev.dataTransfer.items.clear();
        } else {
          ev.dataTransfer.clearData();
        }
      }
    </script>
  </body>
  </html>

